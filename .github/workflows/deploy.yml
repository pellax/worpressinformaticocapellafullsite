name: Deploy to OVH

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ Instalar dependencias
        working-directory: ./frontend
        run: npm ci
      
      - name: ğŸ—ï¸ Build producciÃ³n
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_WORDPRESS_API_URL: ${{ secrets.WORDPRESS_API_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.SITE_URL }}
        run: npm run build
      
      - name: ğŸ“¤ Deploy vÃ­a FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./frontend/.next/standalone/
          server-dir: /www/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.next/cache/**
      
      - name: ğŸ“¤ Deploy archivos estÃ¡ticos
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./frontend/public/
          server-dir: /www/public/
          dangerous-clean-slate: false
      
      - name: ğŸ“¤ Deploy archivos .next/static
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./frontend/.next/static/
          server-dir: /www/.next/static/
          dangerous-clean-slate: false
      
      - name: âœ… Deploy completado
        run: |
          echo "ğŸ‰ Deploy exitoso!"
          echo "ğŸŒ Sitio: ${{ secrets.SITE_URL }}"
